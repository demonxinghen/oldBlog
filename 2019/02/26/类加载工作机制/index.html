<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>类加载工作机制 | 我的博客</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">类加载工作机制</h1><a id="logo" href="/.">我的博客</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">类加载工作机制</h1><div class="post-meta"><a href="/2019/02/26/类加载工作机制/#comments" class="comment-count"></a><p><span class="date">Feb 26, 2019</span><span><a href="/categories/Java/" class="category">Java</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><p>Java源码编译由三个过程组成：源码编译机制、类加载机制、类执行机制。</p>
<h3 id="类的生命周期："><a href="#类的生命周期：" class="headerlink" title="类的生命周期："></a>类的生命周期：</h3><p>加载(Loading)–验证(Verification)–准备(Preparation)–解析(Resolution)–初始化(Initialization)–使用(Using)–卸载(Unloading)。<br>其中从加载到初始化五个阶段属于类加载的部分，验证–准备–解析三个阶段又合称为连接。</p>
<p>加载、验证、准备、初始化和卸载这5个阶段的顺序是确定的，类的加载过程必须按照这种顺序按部就班地开始，而解析阶段则不一定：它在某些情况下可以在初始化阶段之后再开始，这是为了支持Java语言的运行时绑定（也称为动态绑定或晚期绑定）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">系统可能在第一次使用某个类时加载该类，也可能采用预加载机制来加载某个类。</span><br></pre></td></tr></table></figure>
<h4 id="1-加载"><a href="#1-加载" class="headerlink" title="1.加载"></a>1.加载</h4><p>在加载阶段(可以参考java.lang.ClassLoader的loadClass()方法)，虚拟机主要完成三件事：<br>1.1通过一个类的全限定名来获取定义此类的二进制字节流(并没有指明要从Class文件获取，也可以通过其他渠道，譬如：网络、动态生成、数据库等)<br>1.2将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。<br>1.3在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口。</p>
<h4 id="2-验证"><a href="#2-验证" class="headerlink" title="2.验证"></a>2.验证</h4><p>验证的主要目的是判断class文件的合法性，比如class文件一定是以0xCAFEBABE开头的，另外对版本号也会做验证，例如使用jdk1.8编译的class文件在jdk1.6虚拟机上运行，因为版本问题就会验证不通过。除此之外还会对元数据、字节码进行验证，具体的验证过程略过。</p>
<h4 id="3-准备"><a href="#3-准备" class="headerlink" title="3.准备"></a>3.准备</h4><p>这个阶段正式为类变量（static修饰的变量）分配内存并设置初始值，这个内存分配是发生在方法区中。<br>3.1这里并没有对实例变量进行内存分配，实例变量会在对象实例化时随着对象一起分配在Java堆中。<br>3.2这里的初始值，是指数据类型的零值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private static int a = 3;</span><br><span class="line">这个类变量a是在准备阶段设置为0，在初始化阶段将3赋值给变量a。</span><br></pre></td></tr></table></figure>
<p>但是如果是static final的变量，在准备阶段就会赋值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private static final int b = 1;</span><br><span class="line">这段代码在准备阶段就会将1赋值给变量b。</span><br></pre></td></tr></table></figure>
<h4 id="4-解析"><a href="#4-解析" class="headerlink" title="4.解析"></a>4.解析</h4><p>解析过程就是讲符号引用替换为直接引用。</p>
<blockquote>
<p>注：符号引用就是一个Java源文件在被编译时，在不清楚被引用类实际内存地址的情况下，会使用唯一识别并定位到目标的符号来代替。如A类引用了B类，编译时A并不知道B类实际的内存地址，故可以使用能唯一识别B的符号来代替。而当类加载时，编译后的class文件实际已被调入内存，可知道A、B的实际内存地址，当引用的目标已被加载入内存，则此时的引用为直接引用。</p>
</blockquote>
<h4 id="5-初始化"><a href="#5-初始化" class="headerlink" title="5.初始化"></a>5.初始化</h4><p>初始化是类加载的最后一步，这个时候才开始执行类中定义的Java程序代码。在这个阶段最重要的事情就是对类变量进行初始化，关注的重点是父子类之间各类资源初始化的顺序。<br>Java中对类变量指定初始值有两种方式：1.声明类变量时指定初始值。2.使用静态初始化块为类变量指定初始值。<br>初始化的时机<br>3.1创建类实例的时候，分别有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a.使用new关键字创建实例。</span><br><span class="line"></span><br><span class="line">b.通过反射创建实例。</span><br><span class="line"></span><br><span class="line">c.通过反序列化方式创建实例。</span><br></pre></td></tr></table></figure>
<p>3.2调用某个类的类方法（静态方法）<br>3.3访问某个类或接口的类变量，或为该类变量赋值。<br>3.4初始化某个类的子类。当初始化子类的时候，该子类的所有父类都会被初始化。<br>3.5直接使用java.exe命令来运行某个主类。</p>
<p>除了上面几种方式会自动初始化一个类，其他访问类的方式都称不会触发类的初始化，称为被动引用。如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.子类引用父类的静态变量，不会导致子类初始化。</span><br><span class="line">b.通过数组定义引用类，不会触发此类的初始化。</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SupClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> a = <span class="number">123</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"supclass init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SupClass[] spc = <span class="keyword">new</span> SupClass[<span class="number">10</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 控制台不会有输出。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.引用常量时，不会触发此类的初始化。因为用final修饰的类变量，在编译时就已经确定好放入常量池了，访问该类变量时，等于直接从常量池中获取，并没有初始化该类。</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/Java/">Java</a><a href="/tags/JVM/">JVM</a></div><div class="post-share"><div class="social-share"><span>Share:</span></div></div><div class="post-nav"><a href="/2019/02/27/JVM内存模型/" class="pre">JVM内存模型</a><a href="/2019/02/25/类加载器/" class="next">类加载器</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#类的生命周期："><span class="toc-text">类的生命周期：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-加载"><span class="toc-text">1.加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-验证"><span class="toc-text">2.验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-准备"><span class="toc-text">3.准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-解析"><span class="toc-text">4.解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-初始化"><span class="toc-text">5.初始化</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/03/07/MySql慢日志查询/">MySql慢日志查询</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/06/数据库基本概念/">数据库基本概念</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/04/索引工作原理/">索引工作原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/03/数据结构---B+树/">数据结构---B+树</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/03/数据结构---二叉树/">数据结构---二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/03/数据结构---B-树/">数据结构---B-树</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/27/JVM内存模型/">JVM内存模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/26/类加载工作机制/">类加载工作机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/25/类加载器/">类加载器</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="null" title="待定1" target="_blank">待定1</a><ul></ul><a href="null" title="待定2" target="_blank">待定2</a><ul></ul><a href="null" title="待定3" target="_blank">待定3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><span><a rel="nofollow" target="_blank" href="https://demonxinghen.github.io"> 个人博客</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  }
});</script><script type="text/javascript" src="/js/MathJax-2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><div id="script" type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></div><div id="script" type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></div></body></html>